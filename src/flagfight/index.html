<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flag Fight - Multiplayer Flag Guessing Game</title>
    <link rel="stylesheet" href="../common/common.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.3.2/css/flag-icons.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* Game-specific styles only */
        .flag-container {
            width: 100%;
            max-width: 400px;
            height: 250px;
            margin: 0 auto;
            border: 3px solid #4f46e5;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            background: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flag-container .fi {
            font-size: 12rem;
            line-height: 1;
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-card {
            background: #374151;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .player-card.winner {
            border-color: #10b981;
            background: #064e3b;
        }

        .player-card.current-winner {
            border-color: #f59e0b;
            background: #451a03;
        }

        .timer-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 auto;
            transition: all 0.3s ease;
        }

        .timer-circle.warning {
            border-color: #f59e0b;
            color: #f59e0b;
            animation: pulse 0.5s infinite;
        }

        .timer-circle.danger {
            border-color: #ef4444;
            color: #ef4444;
            animation: pulse 0.3s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .guess-input {
            background: #374151;
            border: 2px solid #4f46e5;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 1.1rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .guess-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .guess-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .round-info {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .loading-flag {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .flag-container {
                height: 200px;
                max-width: 350px;
            }
            
            .flag-container .fi {
                font-size: 8rem;
            }
            
            .timer-circle {
                width: 60px;
                height: 60px;
                font-size: 1.2rem;
            }
            
            .player-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-6xl mx-auto text-center">
        <!-- Navigation -->
        <div class="text-left mb-8">
            <a href="../" class="text-gray-400 no-underline text-sm inline-flex items-center gap-1">
                ‚Üê Back to Games
            </a>
        </div>

        <h1 class="text-4xl md:text-5xl font-bold mb-2 text-indigo-400">Flag Fight</h1>
        <p class="text-gray-400 mb-6">Multiplayer Flag Guessing Challenge</p>

        <div id="setup-screen" class="w-full max-w-2xl mx-auto text-center space-y-6">
            <div id="create-section" class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4">1. Create a Game</h2>
                <p class="text-gray-400 mb-4">Support up to 8 players</p>
                <button id="create-game-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">Create Game</button>
                <div id="host-info" class="hidden mt-4">
                    <p class="mb-2">Share your Host ID with friends:</p>
                    <div class="flex justify-center items-center space-x-2">
                        <input id="host-id-input" type="text" class="bg-gray-700 text-white p-2 rounded-md w-full max-w-md text-center" readonly>
                        <button id="copy-id-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Copy</button>
                    </div>
                    <p id="copy-success" class="text-green-400 mt-2 h-5"></p>
                    <div id="waiting-area" class="mt-6">
                        <p class="text-gray-500 mb-4">Players connected: <span id="player-count">1</span>/8</p>
                        <div id="connected-players" class="space-y-2 mb-4"></div>
                        <button id="start-game-btn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Start Game</button>
                    </div>
                </div>
            </div>

            <div id="or-divider" class="text-gray-500 font-bold text-xl">OR</div>

            <div id="join-section" class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4">2. Join a Game</h2>
                <p class="text-gray-400 mb-2">Enter the Host ID:</p>
                <div class="flex justify-center items-center space-x-2">
                    <input id="join-id-input" type="text" class="bg-gray-700 text-white p-2 rounded-md w-full max-w-xs text-center" placeholder="Enter Host ID...">
                    <button id="join-game-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Join</button>
                </div>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <!-- Round Info -->
            <div class="round-info">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-left">
                        <p class="text-white font-semibold">Round <span id="current-round">1</span></p>
                        <p class="text-indigo-200 text-sm">First to 10 wins</p>
                    </div>
                    <div class="timer-circle" id="timer-circle">
                        <span id="timer-display">10</span>
                    </div>
                    <div class="text-right">
                        <p class="text-white font-semibold">Your Score</p>
                        <p class="text-2xl font-bold text-white" id="my-score">0</p>
                    </div>
                </div>
            </div>

            <!-- Flag Display -->
            <div class="mb-6">
                <div class="flag-container" id="flag-container">
                    <div class="loading-flag">üè¥</div>
                </div>
                <p class="text-gray-400 mt-2 text-sm">Guess the country for this flag</p>
            </div>

            <!-- Guess Input -->
            <div class="mb-6">
                <input type="text" id="guess-input" class="guess-input" placeholder="Type country name..." autocomplete="off">
                <p class="text-gray-500 text-sm mt-2">Answers accepted in English or French</p>
            </div>

            <!-- Message Area -->
            <div id="message-area" class="h-8 mb-6 text-xl font-semibold text-amber-300"></div>

            <!-- Players Scoreboard -->
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-xl font-semibold mb-4">Players</h3>
                <div class="player-list" id="player-list"></div>
            </div>
        </div>
    </div>
    
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg text-center shadow-2xl max-w-md">
            <h2 id="game-over-title" class="text-4xl font-bold mb-4"></h2>
            <p id="game-over-message" class="text-xl mb-6"></p>
            <div id="final-scores" class="mb-6"></div>
            <button id="play-again-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Play Again</button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const createGameBtn = document.getElementById('create-game-btn');
        const copySuccess = document.getElementById('copy-success');
        const hostInfo = document.getElementById('host-info');
        const hostIdInput = document.getElementById('host-id-input');
        const copyIdBtn = document.getElementById('copy-id-btn');
        const joinIdInput = document.getElementById('join-id-input');
        const joinGameBtn = document.getElementById('join-game-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const playerCountEl = document.getElementById('player-count');
        const connectedPlayersEl = document.getElementById('connected-players');
        
        const currentRoundEl = document.getElementById('current-round');
        const timerCircle = document.getElementById('timer-circle');
        const timerDisplay = document.getElementById('timer-display');
        const myScoreEl = document.getElementById('my-score');
        const flagContainer = document.getElementById('flag-container');
        const guessInput = document.getElementById('guess-input');
        const messageArea = document.getElementById('message-area');
        const playerListEl = document.getElementById('player-list');
        
        const gameOverModal = document.getElementById('game-over-modal');
        const gameOverTitle = document.getElementById('game-over-title');
        const gameOverMessage = document.getElementById('game-over-message');
        const finalScoresEl = document.getElementById('final-scores');
        const playAgainBtn = document.getElementById('play-again-btn');

        // --- Game State & P2P ---
        let peer;
        let connections = new Map(); // For host: store all player connections
        let hostConnection; // For guests: connection to host
        let isHost = false;
        let gameActive = false;
        let myPlayerId = '';
        let myPlayerName = '';
        const MAX_PLAYERS = 8;
        const WINNING_SCORE = 10;
        const ROUND_TIME = 10; // seconds
        
        let gameState = {
            players: new Map(), // playerId -> { name, score, isHost }
            currentRound: 1,
            currentFlag: null,
            roundTimer: ROUND_TIME,
            roundActive: false,
            roundWinner: null
        };

        // --- Country Data ---
        // Using REST Countries API for flags: https://flagcdn.com/
        const countries = [
            { code: 'fr', names: ['France', 'Francia'] },
            { code: 'de', names: ['Germany', 'Allemagne', 'Alemania'] },
            { code: 'it', names: ['Italy', 'Italie', 'Italia'] },
            { code: 'es', names: ['Spain', 'Espagne', 'Espa√±a'] },
            { code: 'gb', names: ['United Kingdom', 'Royaume-Uni', 'Reino Unido', 'England', 'Angleterre'] },
            { code: 'us', names: ['United States', '√âtats-Unis', 'Estados Unidos', 'USA', 'America', 'Am√©rique'] },
            { code: 'ca', names: ['Canada', 'Canad√°'] },
            { code: 'mx', names: ['Mexico', 'Mexique', 'M√©xico'] },
            { code: 'br', names: ['Brazil', 'Br√©sil', 'Brasil'] },
            { code: 'ar', names: ['Argentina', 'Argentine'] },
            { code: 'cl', names: ['Chile', 'Chili'] },
            { code: 'pe', names: ['Peru', 'P√©rou', 'Per√∫'] },
            { code: 'co', names: ['Colombia', 'Colombie'] },
            { code: 've', names: ['Venezuela', 'V√©n√©zu√©la'] },
            { code: 'jp', names: ['Japan', 'Japon', 'Jap√≥n'] },
            { code: 'cn', names: ['China', 'Chine'] },
            { code: 'in', names: ['India', 'Inde'] },
            { code: 'kp', names: ['North Korea', 'Cor√©e du Nord', 'Corea del Norte'] },
            { code: 'th', names: ['Thailand', 'Tha√Ølande', 'Tailandia'] },
            { code: 'vn', names: ['Vietnam', 'Vi√™t Nam'] },
            { code: 'au', names: ['Australia', 'Australie'] },
            { code: 'nz', names: ['New Zealand', 'Nouvelle-Z√©lande', 'Nueva Zelanda'] },
            { code: 'za', names: ['South Africa', 'Afrique du Sud', 'Sud√°frica'] },
            { code: 'eg', names: ['Egypt', '√âgypte', 'Egipto'] },
            { code: 'ma', names: ['Morocco', 'Maroc', 'Marruecos'] },
            { code: 'ng', names: ['Nigeria', 'Nig√©ria'] },
            { code: 'ke', names: ['Kenya', 'Kenia'] },
            { code: 'ru', names: ['Russia', 'Russie', 'Rusia'] },
            { code: 'pl', names: ['Poland', 'Pologne', 'Polonia'] },
            { code: 'se', names: ['Sweden', 'Su√®de', 'Suecia'] },
            { code: 'no', names: ['Norway', 'Norv√®ge', 'Noruega'] },
            { code: 'fi', names: ['Finland', 'Finlande', 'Finlandia'] },
            { code: 'dk', names: ['Denmark', 'Danemark', 'Dinamarca'] },
            { code: 'nl', names: ['Netherlands', 'Pays-Bas', 'Pa√≠ses Bajos', 'Holland', 'Hollande'] },
            { code: 'be', names: ['Belgium', 'Belgique', 'B√©lgica'] },
            { code: 'ch', names: ['Switzerland', 'Suisse', 'Suiza'] },
            { code: 'at', names: ['Austria', 'Autriche'] },
            { code: 'pt', names: ['Portugal'] },
            { code: 'gr', names: ['Greece', 'Gr√®ce', 'Grecia'] },
            { code: 'tr', names: ['Turkey', 'Turquie', 'Turqu√≠a'] },
            { code: 'sa', names: ['Saudi Arabia', 'Arabie Saoudite', 'Arabia Saud√≠'] },
            { code: 'ae', names: ['United Arab Emirates', '√âmirats Arabes Unis', 'Emiratos √Årabes Unidos', 'UAE'] },
            { code: 'il', names: ['Israel', 'Isra√´l'] },
            { code: 'ir', names: ['Iran', 'Ir√°n'] },
            { code: 'iq', names: ['Iraq', 'Irak'] },
            { code: 'pk', names: ['Pakistan', 'Pakist√°n'] },
            { code: 'bd', names: ['Bangladesh'] },
            { code: 'id', names: ['Indonesia', 'Indon√©sie'] },
            { code: 'my', names: ['Malaysia', 'Malaisie', 'Malasia'] },
            { code: 'ph', names: ['Philippines', 'Filipinas'] },
            { code: 'sg', names: ['Singapore', 'Singapour', 'Singapur'] }
        ];

        let timerInterval;

        // --- Utility Functions ---
        function generatePlayerId() {
            return 'player_' + Math.random().toString(36).substr(2, 9);
        }

        function generatePlayerName() {
            const adjectives = ['Swift', 'Clever', 'Sharp', 'Quick', 'Smart', 'Bright', 'Fast', 'Keen'];
            const nouns = ['Fox', 'Eagle', 'Tiger', 'Lion', 'Wolf', 'Hawk', 'Bear', 'Shark'];
            return adjectives[Math.floor(Math.random() * adjectives.length)] + 
                   nouns[Math.floor(Math.random() * nouns.length)];
        }

        function getFlagClass(countryCode) {
            return `fi fi-${countryCode}`;
        }

        function normalizeGuess(guess) {
            return guess.toLowerCase().trim()
                        .replace(/[√†√°√¢√£√§√•]/g, 'a')
                        .replace(/[√®√©√™√´]/g, 'e')
                        .replace(/[√¨√≠√Æ√Ø]/g, 'i')
                        .replace(/[√≤√≥√¥√µ√∂]/g, 'o')
                        .replace(/[√π√∫√ª√º]/g, 'u')
                        .replace(/[√Ω√ø]/g, 'y')
                        .replace(/[√±]/g, 'n')
                        .replace(/[√ß]/g, 'c');
        }

        function isCorrectGuess(guess, country) {
            const normalizedGuess = normalizeGuess(guess);
            return country.names.some(name => normalizeGuess(name) === normalizedGuess);
        }

        // --- P2P Connection Handling ---
        function initializePeer(hostIdToConnectTo) {
            peer = new Peer();

            peer.on('open', id => {
                myPlayerId = id;
                myPlayerName = generatePlayerName();
                
                if (hostIdToConnectTo) {
                    connectToHost(hostIdToConnectTo);
                } else {
                    hostIdInput.value = id;
                    createGameBtn.classList.add('hidden');
                    hostInfo.classList.remove('hidden');
                    
                    // Add host to players list
                    gameState.players.set(myPlayerId, {
                        name: myPlayerName,
                        score: 0,
                        isHost: true
                    });
                    updateWaitingArea();
                }
            });

            peer.on('connection', newConn => {
                if (isHost && connections.size < MAX_PLAYERS - 1) {
                    setupConnection(newConn);
                } else {
                    newConn.close(); // Reject if game is full
                }
            });
            
            peer.on('error', err => {
                console.error("PeerJS error:", err);
                if (hostIdToConnectTo) {
                    setupScreen.innerHTML = `<h2 class="text-2xl font-semibold text-red-500">Could not connect.</h2><p class="text-gray-400 mt-2">Please check the Host ID and try again.</p>`;
                } else {
                    hostInfo.innerHTML = `<p class="text-red-500">Could not create game. Please refresh and try again.</p>`;
                }
            });
        }

        function connectToHost(hostId) {
            const conn = peer.connect(hostId);
            setupConnection(conn);
        }

        function setupConnection(conn) {
            if (isHost) {
                connections.set(conn.peer, conn);
                
                conn.on('open', () => {
                    // Send current game state to new player
                    conn.send({
                        type: 'welcome',
                        players: Array.from(gameState.players.entries()),
                        hostId: myPlayerId
                    });
                });
                
                conn.on('data', data => handleHostData(data, conn));
                conn.on('close', () => {
                    connections.delete(conn.peer);
                    gameState.players.delete(conn.peer);
                    updateWaitingArea();
                    updatePlayerList();
                    
                    if (gameActive) {
                        broadcastToAll({ type: 'player-left', playerId: conn.peer });
                    }
                });
            } else {
                hostConnection = conn;
                
                conn.on('open', () => {
                    conn.send({
                        type: 'join',
                        playerId: myPlayerId,
                        playerName: myPlayerName
                    });
                });
                
                conn.on('data', handleGuestData);
                conn.on('close', () => {
                    messageArea.textContent = 'Connection to host lost.';
                    setTimeout(() => window.location.reload(), 3000);
                });
            }
        }

        // --- Data Handling ---
        function handleHostData(data, senderConn) {
            switch (data.type) {
                case 'join':
                    if (gameState.players.size < MAX_PLAYERS) {
                        gameState.players.set(data.playerId, {
                            name: data.playerName,
                            score: 0,
                            isHost: false
                        });
                        
                        // Notify all players about new player
                        broadcastToAll({
                            type: 'player-joined',
                            players: Array.from(gameState.players.entries())
                        });
                        
                        updateWaitingArea();
                    } else {
                        senderConn.close();
                    }
                    break;
                    
                case 'guess':
                    if (gameActive && gameState.roundActive) {
                        handlePlayerGuess(data.playerId, data.guess);
                    }
                    break;
                    
                case 'play-again':
                    resetGame();
                    broadcastToAll({ type: 'game-reset' });
                    startNewRound();
                    break;
            }
        }

        function handleGuestData(data) {
            switch (data.type) {
                case 'welcome':
                    gameState.players.clear();
                    data.players.forEach(([id, player]) => {
                        gameState.players.set(id, player);
                    });
                    
                    setupScreen.classList.add('hidden');
                    gameScreen.classList.remove('hidden');
                    updateUI();
                    updatePlayerList();
                    messageArea.textContent = 'Waiting for host to start the game...';
                    break;
                    
                case 'player-joined':
                    gameState.players.clear();
                    data.players.forEach(([id, player]) => {
                        gameState.players.set(id, player);
                    });
                    updatePlayerList();
                    break;
                    
                case 'game-start':
                    gameActive = true;
                    messageArea.textContent = 'Game starting...';
                    break;
                    
                case 'new-round':
                    gameState.currentFlag = data.country;
                    gameState.currentRound = data.round;
                    gameState.roundActive = true;
                    gameState.roundWinner = null;
                    startRoundTimer();
                    updateUI();
                    showFlag(data.country);
                    messageArea.textContent = 'New round! Guess the flag!';
                    guessInput.disabled = false;
                    guessInput.focus();
                    break;
                    
                case 'round-won':
                    gameState.roundActive = false;
                    gameState.roundWinner = data.winner;
                    stopTimer();
                    
                    // Update scores
                    data.players.forEach(([id, player]) => {
                        gameState.players.set(id, player);
                    });
                    
                    updateUI();
                    updatePlayerList();
                    guessInput.disabled = true;
                    
                    const winner = gameState.players.get(data.winner);
                    if (data.winner === myPlayerId) {
                        messageArea.textContent = 'You won the round! üéâ';
                    } else {
                        messageArea.textContent = `${winner.name} won the round!`;
                    }
                    break;
                    
                case 'round-timeout':
                    gameState.roundActive = false;
                    stopTimer();
                    guessInput.disabled = true;
                    messageArea.textContent = `Time's up! It was ${data.countryName}`;
                    break;
                    
                case 'game-over':
                    gameActive = false;
                    const gameWinner = gameState.players.get(data.winner);
                    showGameOver(gameWinner, data.winner === myPlayerId);
                    break;
                    
                case 'game-reset':
                    resetGame();
                    gameOverModal.classList.add('hidden');
                    break;
                    
                case 'player-left':
                    gameState.players.delete(data.playerId);
                    updatePlayerList();
                    break;
            }
        }

        function broadcastToAll(data) {
            connections.forEach(conn => {
                try {
                    conn.send(data);
                } catch (e) {
                    console.error('Failed to send data to peer:', e);
                }
            });
        }

        // --- Game Logic ---
        function startGame() {
            if (!isHost || gameState.players.size < 2) return;
            
            gameActive = true;
            startGameBtn.classList.add('hidden');
            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            // Initialize UI for host
            updateUI();
            updatePlayerList();
            
            broadcastToAll({ type: 'game-start' });
            
            setTimeout(() => {
                startNewRound();
            }, 1000);
        }

        function startNewRound() {
            if (!isHost) return;
            
            const randomCountry = countries[Math.floor(Math.random() * countries.length)];
            gameState.currentFlag = randomCountry;
            gameState.roundActive = true;
            gameState.roundWinner = null;
            
            const roundData = {
                type: 'new-round',
                country: randomCountry,
                round: gameState.currentRound
            };
            
            broadcastToAll(roundData);
            
            // Handle for host
            startRoundTimer();
            updateUI();
            showFlag(randomCountry);
            messageArea.textContent = 'New round! Guess the flag!';
            guessInput.disabled = false;
            guessInput.focus();
        }

        function startRoundTimer() {
            gameState.roundTimer = ROUND_TIME;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                gameState.roundTimer--;
                updateTimerDisplay();
                
                if (gameState.roundTimer <= 0) {
                    stopTimer();
                    if (isHost) {
                        handleRoundTimeout();
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            timerDisplay.textContent = gameState.roundTimer;
            
            timerCircle.className = 'timer-circle';
            if (gameState.roundTimer <= 3) {
                timerCircle.classList.add('danger');
            } else if (gameState.roundTimer <= 5) {
                timerCircle.classList.add('warning');
            }
        }

        function handlePlayerGuess(playerId, guess) {
            if (!gameState.roundActive || gameState.roundWinner) return;
            
            if (isCorrectGuess(guess, gameState.currentFlag)) {
                // Player got it right!
                gameState.roundActive = false;
                gameState.roundWinner = playerId;
                stopTimer();
                
                // Update score
                const player = gameState.players.get(playerId);
                player.score++;
                
                // Check for game winner
                if (player.score >= WINNING_SCORE) {
                    const gameOverData = {
                        type: 'game-over',
                        winner: playerId,
                        players: Array.from(gameState.players.entries())
                    };
                    
                    broadcastToAll(gameOverData);
                    
                    gameActive = false;
                    showGameOver(player, playerId === myPlayerId);
                    return;
                }
                
                // Send round result
                const roundResultData = {
                    type: 'round-won',
                    winner: playerId,
                    players: Array.from(gameState.players.entries()),
                    correctAnswer: gameState.currentFlag.names[0]
                };
                
                broadcastToAll(roundResultData);
                
                // Update host UI as well
                gameState.roundActive = false;
                gameState.roundWinner = playerId;
                stopTimer();
                updateUI();
                updatePlayerList();
                guessInput.disabled = true;
                
                const winner = gameState.players.get(playerId);
                if (playerId === myPlayerId) {
                    messageArea.textContent = 'You won the round! üéâ';
                } else {
                    messageArea.textContent = `${winner.name} won the round!`;
                }
                
                // Start next round after delay
                gameState.currentRound++;
                setTimeout(() => {
                    if (gameActive) {
                        startNewRound();
                    }
                }, 3000);
            }
        }

        function handleRoundTimeout() {
            if (!gameState.roundActive) return;
            
            gameState.roundActive = false;
            
            broadcastToAll({
                type: 'round-timeout',
                countryName: gameState.currentFlag.names[0]
            });
            
            // Start next round after delay
            setTimeout(() => {
                if (gameActive) {
                    startNewRound();
                }
            }, 3000);
        }

        function showFlag(country) {
            const flagElement = document.createElement('span');
            flagElement.className = getFlagClass(country.code);
            flagElement.title = 'Flag to guess';
            flagContainer.innerHTML = '';
            flagContainer.appendChild(flagElement);
            
            // Fallback: if flag doesn't load after 1 second, show country code
            setTimeout(() => {
                const computedStyle = window.getComputedStyle(flagElement);
                if (!flagElement.offsetHeight || computedStyle.fontSize === '0px') {
                    flagElement.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 4rem; font-weight: bold; color: white; background: linear-gradient(45deg, #4f46e5, #7c3aed);">${country.code.toUpperCase()}</div>`;
                    flagElement.className = '';
                }
            }, 1000);
        }

        function makeGuess() {
            const guess = guessInput.value.trim();
            if (!guess || !gameState.roundActive || gameState.roundWinner) return;
            
            if (isHost) {
                handlePlayerGuess(myPlayerId, guess);
            } else {
                hostConnection.send({
                    type: 'guess',
                    playerId: myPlayerId,
                    guess: guess
                });
            }
            
            guessInput.value = '';
        }

        function resetGame() {
            gameState.currentRound = 1;
            gameState.roundActive = false;
            gameState.roundWinner = null;
            stopTimer();
            
            // Reset all player scores
            gameState.players.forEach(player => {
                player.score = 0;
            });
            
            updateUI();
            updatePlayerList();
            gameActive = true;
        }

        function showGameOver(winner, isMe) {
            gameActive = false;
            
            if (isMe) {
                gameOverTitle.textContent = 'You Win! üèÜ';
                gameOverMessage.textContent = `Congratulations! You reached ${WINNING_SCORE} points!`;
            } else {
                gameOverTitle.textContent = 'Game Over';
                gameOverMessage.textContent = `${winner.name} wins with ${WINNING_SCORE} points!`;
            }
            
            // Show final scores
            const sortedPlayers = Array.from(gameState.players.values())
                .sort((a, b) => b.score - a.score);
                
            finalScoresEl.innerHTML = '<h4 class="font-semibold mb-2">Final Scores:</h4>' +
                sortedPlayers.map((player, index) => 
                    `<div class="flex justify-between py-1">
                        <span>${index + 1}. ${player.name}</span>
                        <span>${player.score} points</span>
                    </div>`
                ).join('');
            
            gameOverModal.classList.remove('hidden');
        }

        // --- UI Updates ---
        function updateWaitingArea() {
            playerCountEl.textContent = gameState.players.size;
            
            const playersHtml = Array.from(gameState.players.values())
                .map(player => 
                    `<div class="bg-gray-700 px-3 py-2 rounded">
                        ${player.name} ${player.isHost ? '(Host)' : ''}
                    </div>`
                ).join('');
            
            connectedPlayersEl.innerHTML = playersHtml;
            
            if (gameState.players.size >= 2) {
                startGameBtn.classList.remove('hidden');
            } else {
                startGameBtn.classList.add('hidden');
            }
        }

        function updatePlayerList() {
            const sortedPlayers = Array.from(gameState.players.entries())
                .sort(([,a], [,b]) => b.score - a.score);
                
            playerListEl.innerHTML = sortedPlayers.map(([id, player]) => {
                let cardClass = 'player-card';
                if (id === gameState.roundWinner) {
                    cardClass += ' current-winner';
                } else if (player.score === Math.max(...Array.from(gameState.players.values()).map(p => p.score)) && player.score > 0) {
                    cardClass += ' winner';
                }
                
                return `
                    <div class="${cardClass}">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold ${id === myPlayerId ? 'text-indigo-400' : 'text-white'}">
                                ${player.name} ${id === myPlayerId ? '(You)' : ''}
                            </span>
                            <span class="text-2xl font-bold">${player.score}</span>
                        </div>
                        <div class="text-sm text-gray-400 mt-1">
                            ${player.isHost ? 'Host' : 'Player'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateUI() {
            currentRoundEl.textContent = gameState.currentRound;
            const myPlayer = gameState.players.get(myPlayerId);
            if (myPlayer) {
                myScoreEl.textContent = myPlayer.score;
            } else {
                // Ensure score shows 0 even if player not found
                myScoreEl.textContent = '0';
            }
        }

        // --- Event Listeners ---
        copyIdBtn.addEventListener('click', () => {
            hostIdInput.select();
            document.execCommand('copy');
            copySuccess.textContent = 'Copied!';
            setTimeout(() => copySuccess.textContent = '', 2000);
        });

        startGameBtn.addEventListener('click', startGame);

        guessInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                makeGuess();
            }
        });

        playAgainBtn.addEventListener('click', () => {
            if (isHost) {
                resetGame();
                broadcastToAll({ type: 'game-reset' });
                gameOverModal.classList.add('hidden');
                setTimeout(() => startNewRound(), 1000);
            } else {
                hostConnection.send({ type: 'play-again' });
                playAgainBtn.disabled = true;
                playAgainBtn.textContent = 'Waiting for host...';
            }
        });

        // --- Initialization ---
        createGameBtn.addEventListener('click', () => {
            isHost = true;
            createGameBtn.disabled = true;
            createGameBtn.textContent = 'Creating...';
            document.getElementById('join-section').classList.add('hidden');
            document.getElementById('or-divider').classList.add('hidden');
            initializePeer();
        });

        joinGameBtn.addEventListener('click', () => {
            const hostId = joinIdInput.value.trim();
            if (hostId) {
                isHost = false;
                joinGameBtn.disabled = true;
                joinGameBtn.textContent = 'Joining...';
                document.getElementById('create-section').classList.add('hidden');
                document.getElementById('or-divider').classList.add('hidden');
                initializePeer(hostId);
            } else {
                alert('Please enter a valid Host ID.');
            }
        });

        // Initialize
        window.onload = () => {
            // Flag icons are loaded via CSS - no need to preload images
        };
    </script>

</body>
</html>
